{% set title = "Monitor – Sala Alternativă" %}
<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title }}</title>
    <meta http-equiv="refresh" content="10"> <!-- auto-refresh simplu -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ config['ASSET_VER'] }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/monitor.css') }}?v={{ config['ASSET_VER'] }}">

</head>
<body>
<div class="wrap">
    <header>
        <div class="clock" aria-live="polite">{{ ora_curenta }}</div>



        <div class="class-pill">Acum la religie: <strong>Clasa {{ class_id }}</strong></div>
        <div class="date" style="opacity:.75;font-size:1.2rem;margin-top:.1rem">—</div>
    </header>

    <main class="main">
        <section class="card" aria-labelledby="list-coduri">
            <h2 id="list-coduri">Elevi care nu participă la ora de religie</h2>
            <!--            <p class="sub">Fereastră check‑in: {{ window_label }}. Bife verzi = prezenți.</p>-->
            <div class="codes" role="list">
                {% for c in codes %}
                <div class="code" role="listitem">
                    <b>{{ c.code4 }}</b> <!-- mascăm; poți înlocui cu altă logică -->
                    {% if c.status == 'prezent' %}
                    <span class="badge present" title="prezent"><span class="dot"></span> prezent</span>
                    {% elif c.status == 'întârziat' %}
                    <span class="badge late" title="întârziat"><span class="dot"></span> întârziat</span>
                    {% elif c.status == 'plecat' %}
                    <span class="badge gone" title="plecat"><span class="dot"></span> plecat</span>
                    {% else %}
                    <span class="badge missing" title="neconfirmat">neconfirmat</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="counter" aria-live="polite">
                Prezenți: <span class="pill">{{ present_count }} / {{ total }}</span>
            </div>
            <div class="counter" aria-live="polite">
                Plecați: <span class="pill">{{ left_count }} / {{ total }}</span>
            </div>

        </section>

        <aside class="card qr-panel" aria-labelledby="qr-title">
            <h2 id="qr-title">Cod de început de oră</h2>
            <div class="qr-box" aria-label="cod QR — scanează pentru a confirma prezența">
                <img id="qr-img" src="" alt="QR">
            </div>
            <div class="qr-caption" id="qr-scan-text"></div>
            <div id="qr-debug" class="qr-caption" style="user-select:all; max-width:500px"></div>
        </aside>

    </main>

    <footer>
        <span>Copyright (c) 2025 Colegiul Național "Barbu Știrbei" Călărași</span>
        <span class="fs-hint">Sfat: apasă <kbd>F11</kbd> pentru full-screen.</span>
    </footer>
</div>

<script>
    (function(){
      const sessionId = {{ session_id|int }};
      const clockEl = document.querySelector('.clock');
      const subEl = document.querySelector('.sub');
      const counterEl = document.querySelector('.counter .pill');
      const dateEl = document.querySelector('.date');

      async function tick(){
        try{
          const r = await fetch(`/api/monitor_status?session_id=${sessionId}`, {cache:'no-store'});
          if(!r.ok) return;
          const data = await r.json();
          if(clockEl) clockEl.textContent = data.ora_curenta || '--:--';
          if(subEl) subEl.textContent = `Fereastră check‑in: ${data.window_label}. Bife verzi = prezenți.`;
          if(counterEl) counterEl.textContent = `${data.present_count} / ${data.total}`;
          if (dateEl) dateEl.textContent = data.data_curenta || '';
        }catch(e){ /* ignorăm erorile intermitente */ }
        setTimeout(tick, 3000);
      }
      tick();
    })();
</script>

<script>
(function(){
  const params    = new URLSearchParams(location.search);
  const sessionId = Number(params.get('session_id'));
  if (!sessionId) { console.warn('Lipsește ?session_id='); return; }

  const clockEl   = document.querySelector('.clock');
  const dateEl    = document.querySelector('.date');
  const counterEl = document.querySelector('.counter .pill');
  const qrImg     = document.getElementById('qr-img');
  const qrTitleEl = document.getElementById('qr-title');
  const qrDebugEl = document.getElementById('qr-debug');
  const qrScanTextEl = document.getElementById('qr-scan-text');

  let lastToken = null;

  async function tick(){
    try{
      const r = await fetch(`/api/monitor_status?session_id=${sessionId}`, {cache:'no-store'});
      if(!r.ok){ console.log('API status', r.status); setTimeout(tick, 3000); return; }
      const data = await r.json();
      console.log('API:', {mode: data.mode, hasToken: !!data.qr_token});

      if (clockEl)   clockEl.textContent = data.ora_curenta || '--:--';
      if (dateEl)    dateEl.textContent  = data.data_curenta || '';
      if (counterEl) counterEl.textContent = `${data.present_count} / ${data.total}`;

      if (qrTitleEl){
        qrTitleEl.textContent =
          data.mode === 'end'    ? 'Cod de final de oră' :
          data.mode === 'active' ? 'Cod de început de oră' :
          'Ora este în desfășurare';
      }

       if (qrScanTextEl){
        qrScanTextEl.textContent =
          data.mode === 'end'    ? 'Scanează pentru a-ți confirma plecarea' :
          data.mode === 'active' ? 'Scanează pentru a-ți confirma prezența' :
          '-';
      }

      // setează/ascunde QR
      if (data.qr_token){
        const v = encodeURIComponent(data.ora_curenta || Date.now());
        const src = `/qr.png?token=${data.qr_token}&v=${v}`;
        if (qrImg){
          qrImg.src = src;
          qrImg.style.visibility = 'visible';
        }
        if (qrDebugEl) qrDebugEl.textContent = `${location.origin}/elev?token=${data.qr_token}`;
        lastToken = data.qr_token;
        console.log('SET QR IMG:', src);
      } else {
        if (qrImg) qrImg.style.visibility = 'hidden';
        if (qrDebugEl) qrDebugEl.textContent = '';
      }
    } catch(e){
      console.error('tick error', e);
    }
    setTimeout(tick, 3000);
  }
  tick();
})();
</script>


</body>
</html>