{% set title = "Check‑in – Cod de 4 cifre" %}
<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ config['ASSET_VER'] }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/elev.css') }}?v={{ config['ASSET_VER'] }}">

</head>
<body>
<div class="wrap">
    <div class="phone" role="region" aria-label="Ecran check-in – cod de 4 cifre">

        <header>
            <div class="brand">Sala <b>Alternativă</b></div>
            <div class="time">&nbsp;</div>
        </header>


        <div class="content">
            <div class="title">Confirmă prezența</div>
            <div class="sub">Introdu codul tău de 4 cifre, apoi apasă „Confirmă”.</div>
            {% if message %}
            <div class="success" aria-live="polite"><span class="dot"></span> {{ message }}{% if status_final %} — <b>{{
                status_final }}</b>{% endif %}
            </div>
            {% endif %}
            <form class="code" action="{{ url_for('main.elev') }}" method="post" autocomplete="one-time-code">
                <input type="hidden" name="token" value="{{ request.args.get('token','') }}">
                <input type="hidden" name="device_id" id="device-id" value="">
                <div class="code-boxes" aria-label="Introdu codul din 4 cifre">
                    <input class="digit" name="d1" inputmode="numeric" pattern="[0-9]*" maxlength="1"
                           aria-label="Cifra 1"/>
                    <input class="digit" name="d2" inputmode="numeric" pattern="[0-9]*" maxlength="1"
                           aria-label="Cifra 2"/>
                    <input class="digit" name="d3" inputmode="numeric" pattern="[0-9]*" maxlength="1"
                           aria-label="Cifra 3"/>
                    <input class="digit" name="d4" inputmode="numeric" pattern="[0-9]*" maxlength="1"
                           aria-label="Cifra 4"/>
                </div>
                <div class="hint">Identificator: 4 cifre (definit de școală). Nu salvăm nume.</div>
                <div class="actions">
                    <button class="btn" type="submit">Confirmă</button>
                    <button class="btn secondary" type="reset">Șterge</button>
                </div>
            </form>
        </div>

  
    </div>
</div>

<script>
(function(){
  // Generez un UUID v4 simplu
  function uuidv4(){
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // Citește sau creează un device_id persistent pe acest browser
  function getDeviceId(){
    const KEY = 'sa_device_id';
    let id = localStorage.getItem(KEY);
    if (!id) {
      id = uuidv4();
      try { localStorage.setItem(KEY, id); } catch(e) { /* fallback: tot îl trimitem o dată */ }
    }
    return id;
  }

  // Setează hidden-ul din formular
  const devInput = document.getElementById('device-id');
  if (devInput) devInput.value = getDeviceId();
})();
</script>


<script>
(function(){
  const form   = document.querySelector('form.code');
  const inputs = Array.from(form.querySelectorAll('input.digit'));

  // helperi
  const onlyDigit = s => (s||'').replace(/\D/g,'');
  const focusAt = i => { if (inputs[i]) { inputs[i].focus(); inputs[i].select?.(); } };

  // input: ține doar prima cifră și mergi mai departe
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', (e) => {
      let v = onlyDigit(e.target.value);
      if (v.length > 1) {
        // paste în câmp (ex: “1234”): distribuie pe următoarele
        const chunk = v.slice(0, inputs.length - idx);
        for (let k = 0; k < chunk.length; k++) {
          inputs[idx + k].value = chunk[k];
        }
        const next = Math.min(idx + chunk.length, inputs.length - 1);
        focusAt(next);
      } else {
        e.target.value = v.slice(0,1);
        if (v && idx < inputs.length - 1) focusAt(idx + 1);
      }
    });

    // backspace: dacă e gol, du-te înapoi și șterge acolo
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !inp.value && idx > 0) {
        e.preventDefault();
        inputs[idx - 1].value = '';
        focusAt(idx - 1);
      } else if (e.key === 'ArrowLeft' && idx > 0) {
        e.preventDefault(); focusAt(idx - 1);
      } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
        e.preventDefault(); focusAt(idx + 1);
      } else if (e.key === 'Enter') {
        // Enter: dacă toate au cifră, trimite
        if (inputs.every(i => i.value && /\d/.test(i.value))) {
          form.requestSubmit ? form.requestSubmit() : form.submit();
        }
      }
    });

    // focus: selectează conținutul pentru rescriere rapidă
    inp.addEventListener('focus', () => inp.select?.());
    // lipire pe oricare câmp: distribuie automat
    inp.addEventListener('paste', async (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      const digits = onlyDigit(text).slice(0, inputs.length);
      if (!digits) return;
      const start = idx;
      for (let k = 0; k < digits.length && start + k < inputs.length; k++) {
        inputs[start + k].value = digits[k];
      }
      const last = Math.min(start + digits.length - 1, inputs.length - 1);
      focusAt(last);
    });
  });

  // autofocus pe prima, dar numai dacă nu e deja ceva introdus
  if (inputs.every(i => !i.value)) focusAt(0);
})();
</script>

</body>
</html>
