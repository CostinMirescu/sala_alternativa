{% set title = "Monitor – Sala Alternativă" %}
<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title }}</title>
    <meta http-equiv="refresh" content="10"> <!-- auto-refresh simplu -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ config['ASSET_VER'] }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/monitor.css') }}?v={{ config['ASSET_VER'] }}">

</head>
<body>
<div class="wrap">
    <header>
        <div class="clock" aria-live="polite">{{ ora_curenta }}</div>


        <div class="class-pill">Acum la Religie: <strong>Clasa {{ class_id }}</strong></div>
        <div class="date" style="opacity:.75;font-size:1.2rem;margin-top:.1rem">{{ data_curenta }}</div>
    </header>

    <main class="main">
        <section class="card" aria-labelledby="list-coduri">
            <h2 id="list-coduri">Elevi care nu participă la ora de Religie</h2>
            <!--            <p class="sub">Fereastră check‑in: {{ window_label }}. Bife verzi = prezenți.</p>-->
            <div class="codes" role="list">
                {% for c in codes %}
                <div class="code" role="listitem">
                    <b>{{ c.code4 }}</b> <!-- mascăm; poți înlocui cu altă logică -->
                    {% if c.status == 'prezent' %}
                    <span class="badge present" title="prezent"><span class="dot"></span> prezent</span>
                    {% elif c.status == 'întârziat' %}
                    <span class="badge late" title="întârziat"><span class="dot"></span> întârziat</span>
                    {% elif c.status == 'plecat' %}
                    <span class="badge gone" title="plecat"><span class="dot"></span> plecat</span>
                    {% else %}
                    <span class="badge missing" title="neconfirmat">neconfirmat</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="counter" aria-live="polite">
                Prezenți: <span class="pill" id="present-pill">0 / 0</span>
            </div>
            <div class="counter" aria-live="polite">
                Plecați: <span class="pill" id="left-pill">0 / 0</span>
            </div>

        </section>

        <aside class="card qr-panel" aria-labelledby="qr-title">
            <h2 id="qr-title">Cod de început de oră</h2>
            <div class="qr-box" aria-label="cod QR — scanează pentru a confirma prezența">
                <img id="qr-img" src="" alt="QR">
                <div id="qr-ph" aria-hidden="true" style="display:none;
         width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
                    <div style="text-align:center;color:#334155">
                        <!-- un mini-placeholder (emoji/ASCII e suficient) -->
                        <div style="font-size:3rem;line-height:1">⌛</div>
                    </div>
                </div>
            </div>
            <div class="qr-caption" id="qr-scan-text"></div>
            <div id="qr-debug" class="qr-caption" style="user-select:all; max-width:500px"></div>
        </aside>

    </main>

    <footer>
        <span>Copyright (c) 2025 Colegiul Național "Barbu Știrbei" Călărași</span>
        <span class="fs-hint">Sfat: apasă <kbd>F11</kbd> pentru full-screen.</span>
    </footer>
</div>

<script>
(function () {
  const sessionId = Number(new URLSearchParams(location.search).get('session_id'));
  if (!sessionId) { console.warn('Lipsește ?session_id='); return; }

  const clockEl      = document.querySelector('.clock');
  const dateEl       = document.querySelector('.date');
  const subEl        = document.querySelector('.sub');
  const presentPill  = document.getElementById('present-pill');
  const leftPill     = document.getElementById('left-pill');
  const qrImg        = document.getElementById('qr-img');
  const qrTitleEl    = document.getElementById('qr-title');
  const qrDebugEl    = document.getElementById('qr-debug');
  const qrScanTextEl = document.getElementById('qr-scan-text');
  const qrPhEl       = document.getElementById('qr-ph');

  const prev = {
    ora_curenta: null, data_curenta: null, present_count: null,
    total: null, left_count: null, mode: null, qr_token: null,
    window_label: null,
  };

  function setText(el, text, key) {
    if (!el) return;
    if (prev[key] !== text) {
      prev[key] = text;
      requestAnimationFrame(() => { el.textContent = text; });
    }
  }

  function scheduleNextTick(mode, nextAtISO){
    const FAST = 3000, SLOW = 60000;
    if (nextAtISO && (mode === 'off' || mode === 'sleep')) {
      const t = Date.parse(nextAtISO);
      const delay = Math.max(0, t - Date.now() + 250);
      setTimeout(tick, Math.min(delay, SLOW));
      return;
    }
    const interval = (mode === 'active' || mode === 'end') ? FAST : SLOW;
    setTimeout(tick, interval);
  }

  async function tick() {
    try {
      const r = await fetch(`/api/monitor_status?session_id=${sessionId}`, { cache: 'no-store' });
      if (!r.ok) { scheduleNextTick('off'); return; }
      const data = await r.json();

      setText(clockEl, data.ora_curenta || '--:--', 'ora_curenta');
      setText(dateEl,  data.data_curenta || '{{ data_curenta }}', 'data_curenta');

      const subText = data.window_label ? `Fereastră check-in: ${data.window_label}. Bife verzi = prezenți.` : '';
      setText(subEl, subText, 'window_label');

      setText(presentPill, `${data.present_count} / ${data.total}`, 'present_count_total');
      setText(leftPill,    `${(data.left_count ?? 0)} / ${data.present_count}`, 'left_over_present');

      const titleText =
        data.mode === 'end'    ? 'Cod de final de oră' :
        data.mode === 'active' ? 'Cod de început de oră' :
                                  'În afara orelor';
      setText(qrTitleEl, titleText, 'mode_title');

      const scanText =
        data.mode === 'end'    ? 'Scanează pentru a-ți confirma plecarea' :
        data.mode === 'active' ? 'Scanează pentru a-ți confirma prezența' :
                                  'Nu există o sesiune activă.';
      setText(qrScanTextEl, scanText, 'scan_text');

      // QR / placeholder
      if (data.qr_token) {
        if (prev.qr_token !== data.qr_token) {
          prev.qr_token = data.qr_token;
          const src = `/qr.png?token=${data.qr_token}`;
          requestAnimationFrame(() => {
            if (qrImg) { qrImg.src = src; qrImg.style.display = 'block'; }
            if (qrPhEl) qrPhEl.style.display = 'none';
            if (qrDebugEl) qrDebugEl.textContent = `${location.origin}/elev?token=${data.qr_token}`;
          });
        }
      } else {
        if (prev.qr_token !== null) prev.qr_token = null;
        requestAnimationFrame(() => {
          if (qrImg)   qrImg.style.display = 'none';
          if (qrPhEl)  qrPhEl.style.display = 'flex';
          if (qrDebugEl) qrDebugEl.textContent = '';
        });
      }

      // programăm următorul tick în funcție de mod/next_window_at
      scheduleNextTick(data.mode, data.next_window_at);

    } catch (e) {
      console.error('tick error', e);
      scheduleNextTick('off');
    }
  }

  tick();
})();
</script>



</body>
</html>